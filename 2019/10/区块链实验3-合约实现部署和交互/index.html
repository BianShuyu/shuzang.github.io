<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>区块链实验3-合约实现、部署和交互 | Shuzang&#39;s Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="shuzang's personal blog"><link rel=prev href=https://shuzang.github.io/i-still-love-you/><link rel=next href=https://shuzang.github.io/2019/10/edgechain-an-edge-iot-framework-and-prototype.../><link rel=canonical href=https://shuzang.github.io/2019/10/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C3-%E5%90%88%E7%BA%A6%E5%AE%9E%E7%8E%B0%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BA%A4%E4%BA%92/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="区块链实验3-合约实现、部署和交互"><meta name=twitter:description content="这里介绍三种合约中定义的功能，以及如何部署合约和测试。 1. 合约中定义的功能 共有RC(Register Contract)，ACC(Access Control"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"区块链实验3-合约实现、部署和交互","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2019\/10\/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C3-%E5%90%88%E7%BA%A6%E5%AE%9E%E7%8E%B0%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BA%A4%E4%BA%92\/"},"image":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"区块链开发","wordcount":4153,"url":"https:\/\/shuzang.github.io\/2019\/10\/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%9E%E9%AA%8C3-%E5%90%88%E7%BA%A6%E5%AE%9E%E7%8E%B0%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BA%A4%E4%BA%92\/","datePublished":"2019-10-15T00:00:00\x2b00:00","dateModified":"2019-10-15T00:00:00\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"shuzang","logo":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=https://shuzang.github.io>Shuzang&#39;s Blog</a></div><div class=navbar-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/life>Life</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=https://shuzang.github.io>Shuzang&#39;s Blog</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=https://shuzang.github.io/posts>Posts</a><a class=menu-item href=https://shuzang.github.io/categories>Categories</a><a class=menu-item href=https://shuzang.github.io/tags>Tags</a><a class=menu-item href=https://shuzang.github.io/life>Life</a><a class=menu-item href=https://shuzang.github.io/about>About</a><a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><main class=main><div class=container><article class=page><h1 class="post-title animated flipInX">区块链实验3-合约实现、部署和交互</h1><div class=post-meta><div class=post-meta-main><a class=author href=https://shuzang.github.io rel=author target=_blank><i class="fas fa-user-circle fa-fw"></i>shuzang
</a>&nbsp;<span class=post-category>included in&nbsp;<i class="far fa-folder fa-fw"></i><a href=https://shuzang.github.io/categories/%E7%A0%94%E7%A9%B6%E7%94%9F%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/>研究生的区块链学习之路</a>&nbsp;</span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2019-10-15>2019-10-15</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 4153 words&nbsp;
<i class="far fa-clock fa-fw"></i>9 min&nbsp;</div></div><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-合约中定义的功能>1. 合约中定义的功能</a><ul><li><a href=#rc>RC</a></li><li><a href=#acc>ACC</a></li><li><a href=#jc>JC</a></li></ul></li><li><a href=#2-进行功能测试时与合约的交互流程>2. 进行功能测试时与合约的交互流程</a></li><li><a href=#3-实验如何进行>3. 实验如何进行</a></li><li><a href=#4-其它说明>4. 其它说明</a><ul><li><a href=#两个js脚本的大致算法如下>两个js脚本的大致算法如下</a></li><li><a href=#web3-js与节点交互的参考文档>web3.js与节点交互的参考文档</a></li><li><a href=#可能遇到的问题及解决方案>可能遇到的问题及解决方案</a></li><li><a href=#合约部署的方式>合约部署的方式</a></li><li><a href=#执行js命令的方式>执行js命令的方式</a></li></ul></li></ul></li></ul></nav></div></div><div class=post-toc-mobile id=post-toc-mobile><details><summary><div class=post-toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=post-toc-content><nav id=TableOfContentsMobile><ul><li><ul><li><a href=#1-合约中定义的功能>1. 合约中定义的功能</a><ul><li><a href=#rc>RC</a></li><li><a href=#acc>ACC</a></li><li><a href=#jc>JC</a></li></ul></li><li><a href=#2-进行功能测试时与合约的交互流程>2. 进行功能测试时与合约的交互流程</a></li><li><a href=#3-实验如何进行>3. 实验如何进行</a></li><li><a href=#4-其它说明>4. 其它说明</a><ul><li><a href=#两个js脚本的大致算法如下>两个js脚本的大致算法如下</a></li><li><a href=#web3-js与节点交互的参考文档>web3.js与节点交互的参考文档</a></li><li><a href=#可能遇到的问题及解决方案>可能遇到的问题及解决方案</a></li><li><a href=#合约部署的方式>合约部署的方式</a></li><li><a href=#执行js命令的方式>执行js命令的方式</a></li></ul></li></ul></li></ul></nav></div></details></div><div class=post-content><p>这里介绍三种合约中定义的功能，以及如何部署合约和测试。</p><a class=post-dummy-target id=1-合约中定义的功能></a><h2>1. 合约中定义的功能</h2><p>共有RC(Register Contract)，ACC(Access Control Contract)和JC(Judge Contract)三种合约，分别介绍其中定义的功能</p><a class=post-dummy-target id=rc></a><h3>RC</h3><p>RC的作用主要是注册ACC和JC，在需要的时候返回它们的相关信息，使用了一个lookupTable来存储每个已注册合约的基本信息，这些基本信息包括：</p><table><thead><tr><th>字段名</th><th>解释</th></tr></thead><tbody><tr><td>scName</td><td>注册的合约名</td></tr><tr><td>subject</td><td>subject-object对中的subject地址</td></tr><tr><td>object</td><td>subject-object对中的object地址</td></tr><tr><td>creator</td><td>合约创建者地址</td></tr><tr><td>scAddress</td><td>合约地址</td></tr></tbody></table><p>使用了一个映射结构来构造信息表，<code>mapping(bytes32=&gt;Method) public lookupTable</code>，以上基本信息均作为结构体Method的一部分，作为表的值。表的键是bytes32类型，是方法(method)名，这里方法的含义很模糊，作用应该是描述已注册合约的作用。RC合约定义了如下功能：</p><ol><li>methodRegister：ACC和JC注册</li><li>methodScnameUpdate：已注册的合约名字段更新</li><li>methodAcAddressUpdate：已注册的合约地址字段更新</li><li>methodNameUpdate：方法名更新</li><li>methodDelete：方法删除</li><li>getContractAddr：获取方法名对应的合约地址</li></ol><p>存在的问题</p><ol><li>作为表键的方法名除了带来大量的gas消耗没有任何益处，反而由于处理的难题，使用内联汇编带来了大量gas消耗。可以用注册合约的合约地址作为键，而在Method结构体中新增合约描述字段</li><li>结构体中合约名也没有意义，可与合约描述字段合并，或者更改为合约类型字段，用于区分ACC和JC</li><li>存储注册合约的abi没有意义，反而带来处理上的难题和大量gas消耗，实际上，实验中存在的abi只有三种，RC，ACC和JC，预先记录即可，如果考虑到ACC或JC合约内容变动，可设置指向函数，在改变合约时将请求指向新合约。</li></ol><a class=post-dummy-target id=acc></a><h3>ACC</h3><p>ACC的作用是对subject和object对的每个访问控制方法做描述。拥有两个表，Misbehavior记录行为用作判决，PolicyItem记录访问控制策略用于访问控制。并使用了一个事件返回访问控制相关结果。合约相关函数如下：</p><ol><li>setJC：设置JC合约地址，用于调用JC合约</li><li>policyAdd：策略添加</li><li>getPolicy：策略查询</li><li>policyUpdate：策略权限字段更新</li><li>minIntervalUpdate：策略时间间隔字段更新</li><li>thresholdUpdate：策略阈值字段更新</li><li>policyDelete：策略删除</li><li>accessControl：实施访问控制</li><li>getTimeofUnblock：获取惩罚时间</li><li>deleteACC：合约自我销毁</li></ol><p>ACC由object部署，可以控制subject发起的访问请求。我们假设subject和object就多条访问控制方法达成了一致，因此，一个subject-object对应多个ACC，但一个ACC只对应一个subject-object。</p><a class=post-dummy-target id=jc></a><h3>JC</h3><p>JC的表结构记录了恶意行为，并拥有恶意行为判决函数，同时有一个事件返回判决基本信息，其函数如下：</p><ol><li>misbeaviorJudge：进行恶意行为判决</li><li>getLatestMisbehavior：获取最新判决的一个恶意行为</li><li>deleteJC：合约自我销毁</li></ol><a class=post-dummy-target id=2-进行功能测试时与合约的交互流程></a><h2>2. 进行功能测试时与合约的交互流程</h2><p>根据已定义的函数，可以通过与合约交互实现一些目标，主要如下</p><ol><li><p>注册新的访问控制方法/恶意行为判决方法</p><p>step1：为新方法创建新的ACC</p><p>step2：部署新创建的ACC到区块链</p><p>step3：调用RC合约的 methodRegister 方法注册ACC</p></li><li><p>更新已有的访问控制方法（不觉得有存在的必要）</p><p>step1：创建新的ACC，用于替换旧的</p><p>step2：部署新创建的ACC</p><p>step3：调用RC合约的 methodUpdate 方法更新相关字段，如ScName, ScAddress, ABI等</p><p>step4：调用旧ACC的 deleteACC 方法自我销毁</p></li><li><p>删除已有的访问控制方法</p><p>step1：调用RC合约的 methodDelete 方法从注册表删除方法的相关信息</p><p>step2：调用ACC合约的 deleteACC 方法自我销毁</p></li><li><p>添加，更新和删除策略</p><p>调用ACC合约的 policyAdd, policyUpdate和policyDelete方法完成</p></li><li><p>访问控制</p><p>假设subject和object知道它们间所有可用的访问控制方法，当前有一个subject想访问object的资源，需要执行下列步骤</p><p>step1：subject调用RC合约的 getContract 方法检索用于访问控制的ACC</p><p>step2：RC合约返回所查询ACC的address和ABI给发起查询的subject</p><p>step3：subject调用ACC合约的 accessControl 方法发起访问控制，该交易将被收集到区块中，区块被确认后，accessControl方法得以执行</p><p>step4：访问控制执行期间，ACC调用JC合约的misbehaviorJudge方法查看该subject是否存在恶意行为</p><p>step5：misbehaviorJudge完成恶意行为检测与判决，将判决结果返回给ACC</p><p>step6：访问控制结束后，结果同时返回给subject和object</p></li></ol><a class=post-dummy-target id=3-实验如何进行></a><h2>3. 实验如何进行</h2><p>模拟情景为subject向object发起访问控制请求，实际实施以pi3B+作为subject，以pi3B作为object，实验流程如下</p><ol><li><p>在台式电脑中安装<a href=https://web3js.readthedocs.io/en/v1.2.1/getting-started.html>web3.js</a>，之后通过websocket远程操作树莓派</p><pre><code class=language-bash># 安装npm和node
$ sudo apt-get install npm
# 更新npm到最新
$ sudo npm install npm@latest -g
# 安装node管理工具
$ sudo npm install n -g
# 更新node.js到最新
$ sudo n lts
# 授权普通用户否则npm无法对模块进行本地安装
$ sudo chown -R $(whoami) ~/.npm
$ sudo chown -R $(whoami) ~/.config
# 安装web3.js
$ npm install web3@1.0.0-beta.18
# 查看已安装本地模块列表
$ npm list --depth 0
/home/shuzang/istanbul
└── web3@1.0.0-beta.18
</code></pre><blockquote><p>不建议直接使用<code>npm install web3</code>，默认会安装web3@1.2.1版本，函数调用出现了<code>Transaction has been reverted by the EVM</code>的问题，<a href=https://github.com/ethereum/web3.js/issues/2518>论坛</a>提到这是版本问题，切换了不少版本，但直到1.0.0-beta.18才执行成功。已安装高级版本情况下可以使用如下命令覆盖</p><p><code>$ npm install web3@1.0.0-beta.18 --save</code></p></blockquote></li><li><p>在node0根目录启动geth</p><pre><code class=language-bash>$ ps | grep geth
$ killall -INT geth
$ ./startall.sh
$ geth attach data/geth.ipc
</code></pre><p>解锁账户（之后执行操作脚本都有实现解锁账户，默认账户解锁维持5分钟）</p><pre><code class=language-json>&gt; personal.unlockAccount(eth.accounts[0])
</code></pre></li><li><p>使用Remix编译注册合约(RC)，并在<code>Compilation Details</code>中获取<code>WEB3DEPLOY</code>，复制并粘贴在geth控制台运行，记录返回的交易哈希和合约地址。</p></li><li><p>以同样的方法部署判决合约(JC)，记录返回的交易哈希和合约地址。合约初始化需要的两个参数设置为</p><ul><li>base = 2</li><li>interval = 3</li></ul></li><li><p>调用RC合约的methodRegister函数，注册判决合约</p></li><li><p>在object部署ACC合约，合约初始化参数为subject节点的账户地址，记录返回的交易哈希和账户地址。</p></li><li><p>调用ACC合约的SetJC函数，传入的参数为JC合约地址，用于进行合约调用</p></li><li><p>调用ACC合约的policyAdd函数预定义一批访问控制策略，传入的参数中令时间间隔<code>minInterval=100</code>，阈值<code>threshold=2</code></p><table><thead><tr><th>Resource</th><th>Action</th><th>Permission</th><th>ToLR</th></tr></thead><tbody><tr><td>file A</td><td>read</td><td>allow</td><td>例如：2019-10-04 10:47</td></tr><tr><td>file A</td><td>write</td><td>deny</td><td></td></tr><tr><td>program A</td><td>execute</td><td>deny</td><td></td></tr><tr><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td><td>&hellip;</td></tr></tbody></table></li><li><p>调用ACC合约的getPolicy函数验证定义的策略</p></li><li><p>调用RC合约的methodRegister函数，注册访问控制合约</p></li><li><p>编写object下的monitor.js，用于监听访问控制请求</p><pre><code class=language-js>var Web3 = require('web3');
var web3 = new Web3(Web3.givenProvider || &quot;ws://192.168.191.4:8545&quot;);

var rcAbi = []
var accAbi = &quot; &quot;
   
var rcAddr = &quot;0xa49fe05a90c49c44b7d533c64b8cc33e5e6d582e&quot;;

var methodName = &quot;Access Control&quot;;
var register = new web3.eth.Contract(rcAbi, rcAddr);
register.methods.getContractAddr(methodName).call({
	from: &quot;0x44d13e0c0d91a2ebe570c58cdadef2b99bf55bc1&quot;,
	gas: 10000000
},function(error,result){
	if(!error) {
		listen(result);
	}
});


function listen(accAddr) {
	var myACC = new web3.eth.Contract(accAbi, accAddr);

	myACC.events.ReturnAccessResult({
		fromBlock: 0
	}, function(error, result){
		    if(!error) {
				console.log(&quot;Contract: &quot;+result.address);
				console.log(&quot;Block Number: &quot;+result.blockNumber);
				console.log(&quot;Tx Hash: &quot;+result.transactionHash);
				console.log(&quot;Block Hash: &quot;+result.blockHash);
				console.log(&quot;Time: &quot;+result.returnValues._time);
				console.log(&quot;Message: &quot;+result.returnValues._errmsg);
				console.log(&quot;Result: &quot;+result.returnValues._result);
				if (result.returnValues._penalty &gt; 0) {
					console.log(&quot;Requests are blocked for &quot; + result.returnValues._penalty +&quot;seconds!&quot;)
				}
				console.log('\n');
	    	}
	})
}


</code></pre></li><li><p>编写subject下的requester.js，用于发起访问控制。</p><pre><code class=language-js>var Web3 = require('web3');
var readline = require('readline');
var web3 = new Web3(Web3.givenProvider || &quot;ws://192.168.191.3:8545&quot;);
    
var rcAbi = [];
var accAbi = [];
    
var subject = &quot;0x9abf7020cc405fce60fdfb84168fb9457bde52e2&quot;;
var rcAddr = &quot;0xa49fe05a90c49c44b7d533c64b8cc33e5e6d582e&quot;;
    
var methodName = &quot;Access Control&quot;;
var register = new web3.eth.Contract(rcAbi, rcAddr);
register.methods.getContractAddr(methodName).call({
    from: &quot;0x9abf7020cc405fce60fdfb84168fb9457bde52e2&quot;,
    gas: 10000000
},function(error,result){
    if(!error) {
        sendAccessControl(result);
    }
});
    
function sendAccessControl(accAddr) {
    var myACC = new web3.eth.Contract(accAbi, accAddr);
    
    var previousTxHash = 0;
    var currentTxHash = 0;
    
    var rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout,
        prompt: 'Send access request?(y/n)'
    });
    
    rl.prompt();
    rl.on('line',(answer) =&gt; {
        if('y' == answer) {
        var currentTime = new Date().getTime()/1000;
        myACC.methods.accessControl(&quot;File A&quot;, &quot;read&quot;, currentTime).send({
                from: &quot;0x9abf7020cc405fce60fdfb84168fb9457bde52e2&quot;,
                gas: 10000000
            },function(error,result){
                if(!error){
                    currentTxHash = result
                    console.log(&quot;currentTxHash&quot;, result)
                }
            })
    
        myACC.events.ReturnAccessResult({
                fromBlock: 0
            }, function(error, result){
            if(!error) {
                if(previousTxHash != result.transactionHash &amp;&amp; currentTxHash == result.transactionHash) {
                    console.log(&quot;Contract: &quot;+result.address);
                    console.log(&quot;Block Number: &quot;+result.blockNumber);
                    console.log(&quot;Tx Hash: &quot;+result.transactionHash);
                    console.log(&quot;Block Hash: &quot;+result.blockHash);
                    console.log(&quot;Time: &quot;+result.returnValues._time);
                    console.log(&quot;Message: &quot;+result.returnValues._errmsg);
                    console.log(&quot;Result: &quot;+result.returnValues._result);
                    if (result.returnValues._penalty &gt; 0) {
                        console.log(&quot;Requests are blocked for &quot; + result.returnValues._penalty +&quot;seconds!&quot;)
                    }
                    console.log('\n');
                    previousTxHash = result.transactionHash;
                    rl.prompt();
                }
            }
        })
        }
        else{
        console.log(&quot;access request doesn't send!&quot;)
        rl.prompt();
        }
    }).on('close',() =&gt;{
        console.log('All actions had executed!');
        process.exit(0);
    });
}
</code></pre></li><li><p>将注册合约(RC)的合约地址和Abi，访问控制合约的Abi填充到上面两个js文件的rcAddr，rcAbi和accAbi变量</p></li><li><p>在台式电脑中开启两个控制台界面，先后执行两个脚本。requester.js发起的访问控制返回的结果，monitor.js都能检测到。</p><pre><code class=language-bash>$ node monitor.js
$ node requester.js
</code></pre></li></ol><a class=post-dummy-target id=4-其它说明></a><h2>4. 其它说明</h2><a class=post-dummy-target id=两个js脚本的大致算法如下></a><h3>两个js脚本的大致算法如下</h3><blockquote><p>Algorithm 2 Access Request JavaScript</p><p><strong>Input</strong>: resource, action, time</p><p><strong>Output</strong>: result, penalty</p><p>1: Create a RC instance register.<br>2: Specify the access control method name method.<br>3: (addr, abi)4— register.getContract(method).<br>4: Create an ACC instance acc with addr, abi.<br>5: Send a transaction containing parameters (resource, action, time) to the accessControl ABI of acc.<br>6: while ture do<br>7: if Event returnResult() is captured then<br>8: (result, penalty) 4— returnResult().<br>9: break.<br>10: end if<br>11: end while<br>12: return result, penalty<br><br></p><p>Algorithm 3 Access Monitor JavaScript</p><p>1: Create a RC instance register.<br>2: Specify the access control method name method.<br>3: (addr, abi)4— register.getContract(method).<br>4: Create an ACC instance acc with addr, abi.<br>5: while ture do<br>6: if Event returnResult() is captured then<br>7: (result, penalty) 4— returnResult().<br>8: Display result, penalty.<br>9: end if<br>10: end while</p></blockquote><a class=post-dummy-target id=web3-js与节点交互的参考文档></a><h3>web3.js与节点交互的参考文档</h3><p><a href=https://blog.csdn.net/dieju8330/article/details/83090660>https://blog.csdn.net/dieju8330/article/details/83090660</a></p><p><a href=https://blog.csdn.net/dieju8330/article/details/83149164>https://blog.csdn.net/dieju8330/article/details/83149164</a></p><a class=post-dummy-target id=可能遇到的问题及解决方案></a><h3>可能遇到的问题及解决方案</h3><p>获取节点账户列表</p><pre><code class=language-js>&gt; eth.accounts
</code></pre><p>解锁账户</p><pre><code class=language-js>&gt; personal.unlockAccount(eth.accounts[0])
# 可以解锁时直接添加密码和持续时间(未添加持续时间默认300s，即5分钟)
&gt; personal.unlockAccount(address, &quot;password&quot;, 300)
</code></pre><p>查看已连接节点</p><pre><code class=language-js>&gt; admin.peers
</code></pre><p>启动geth时即解锁账户</p><pre><code class=language-js>geth --unlock &quot;0x...&quot; --password &quot;密码&quot;
</code></pre><p>启动geth时允许远程web3接入</p><pre><code class=language-js>geth --rpccorsdomain &quot;*&quot;
</code></pre><p>remix通过web3 provider部署合约，网址栏https改为http，否则无法连接</p><p>更多关于账户的命令参见<a href=https://github.com/ethereum/go-ethereum/wiki/Managing-your-accounts>Managing your accounts</a></p><a class=post-dummy-target id=合约部署的方式></a><h3>合约部署的方式</h3><ol><li>复制Remix中合约编译生成的web3deploy到geth控制台执行</li><li>使用Remix的web3 Provider远程部署（关闭adblock，使用http，但仍然一直处于creation of Register pending&hellip;中，未知原因，可能是http连接已弃用）</li><li>利用web3.js编写js脚本进行部署</li><li>使用truffle</li></ol><a class=post-dummy-target id=执行js命令的方式></a><h3>执行js命令的方式</h3><p><strong>方法1</strong>：geth控制台执行以下命令，默认路径为执行<code>geth attach</code>的路径</p><pre><code class=language-js>loadScript('requester.js')
</code></pre><p>但总出现类似“err: TypeError: &lsquo;send&rsquo; is not a function”的问题，无法解决，可能是<code>web3.js</code>的问题，网上有人建议换用<code>ethers.js</code></p><p><strong>方法2</strong>：执行<code>geth attach</code>时添加参数</p><pre><code class=language-js>geth --exec 'loadScript(&quot;request.js&quot;)' attach data/geth.ipc
</code></pre><p>使用举例见<a href=https://github.com/ethereum/go-ethereum/wiki/JavaScript-Console>JavaScript Console</a></p><p><strong>方法3</strong>：使用node直接运行</p><pre><code class=language-bash>$ node requester.js
</code></pre><p>方法3是唯一执行成功的。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>The article was updated on 2019-10-15</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href="//twitter.com/share?url=https%3a%2f%2fshuzang.github.io%2f2019%2f10%2f%25E5%258C%25BA%25E5%259D%2597%25E9%2593%25BE%25E5%25AE%259E%25E9%25AA%258C3-%25E5%2590%2588%25E7%25BA%25A6%25E5%25AE%259E%25E7%258E%25B0%25E9%2583%25A8%25E7%25BD%25B2%25E5%2592%258C%25E4%25BA%25A4%25E4%25BA%2592%2f&amp;text=%e5%8c%ba%e5%9d%97%e9%93%be%e5%ae%9e%e9%aa%8c3-%e5%90%88%e7%ba%a6%e5%ae%9e%e7%8e%b0%e3%80%81%e9%83%a8%e7%bd%b2%e5%92%8c%e4%ba%a4%e4%ba%92&amp;via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-fw"></i></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshuzang.github.io%2f2019%2f10%2f%25E5%258C%25BA%25E5%259D%2597%25E9%2593%25BE%25E5%25AE%259E%25E9%25AA%258C3-%25E5%2590%2588%25E7%25BA%25A6%25E5%25AE%259E%25E7%258E%25B0%25E9%2583%25A8%25E7%25BD%25B2%25E5%2592%258C%25E4%25BA%25A4%25E4%25BA%2592%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook-square fa-fw"></i></a><a href="//reddit.com/submit?url=https%3a%2f%2fshuzang.github.io%2f2019%2f10%2f%25E5%258C%25BA%25E5%259D%2597%25E9%2593%25BE%25E5%25AE%259E%25E9%25AA%258C3-%25E5%2590%2588%25E7%25BA%25A6%25E5%25AE%259E%25E7%258E%25B0%25E9%2583%25A8%25E7%25BD%25B2%25E5%2592%258C%25E4%25BA%25A4%25E4%25BA%2592%2f&amp;title=%e5%8c%ba%e5%9d%97%e9%93%be%e5%ae%9e%e9%aa%8c3-%e5%90%88%e7%ba%a6%e5%ae%9e%e7%8e%b0%e3%80%81%e9%83%a8%e7%bd%b2%e5%92%8c%e4%ba%a4%e4%ba%92" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=https://shuzang.github.io/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BC%80%E5%8F%91/><i class="fas fa-tag fa-fw"></i>&nbsp;区块链开发</a>&nbsp;</span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=https://shuzang.github.io>Home</a></span></section></div><div class=post-nav><a href=https://shuzang.github.io/i-still-love-you/ class=prev rel=prev title=我还是喜欢你><i class="fas fa-angle-left fa-fw"></i>我还是喜欢你</a>
<a href=https://shuzang.github.io/2019/10/edgechain-an-edge-iot-framework-and-prototype.../ class=next rel=next title="EdgeChain An Edge-IoT Framework and Prototype...">EdgeChain An Edge-IoT Framework and Prototype...<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shuzang.github.io target=_blank>shuzang</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span>
</a><script src=/js/lib/jquery/jquery.slim.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><link rel=stylesheet href=/css/lib/katex/katex.min.css><script src=/js/lib/katex/katex.min.js></script><script defer src=/js/lib/katex/auto-render.min.js></script><link rel=stylesheet href=/css/lib/katex/copy-tex.min.css><script defer src=/js/lib/katex/copy-tex.min.js></script><script defer src=/js/lib/katex/mhchem.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},]});});</script><script src=/js/blog.min.js></script></body></html>