<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>hugo搭建个人博客4-部署优化 | Shuzang's Blog</title><meta name=Description content="书藏的个人博客，包括Golang、数据结构、算法的学习记录，各类生活技能的学习，每周五发布一期自己的生活周刊"><meta property="og:title" content="hugo搭建个人博客4-部署优化"><meta property="og:description" content="1. 使用CI持续集成 为了存放博客网站源码和博文，一直使用的都是blog仓库，但这同时导致了博客的域名只能是shuzang.github.io/"><meta property="og:type" content="article"><meta property="og:url" content="https://shuzang.github.io/2019/09/hugo-build-blog-deployment-optimization/"><meta property="article:published_time" content="2019-09-29T00:00:00+00:00"><meta property="article:modified_time" content="2020-02-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="hugo搭建个人博客4-部署优化"><meta name=twitter:description content="1. 使用CI持续集成 为了存放博客网站源码和博文，一直使用的都是blog仓库，但这同时导致了博客的域名只能是shuzang.github.io/"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://shuzang.github.io/2019/09/hugo-build-blog-deployment-optimization/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=prev href=https://shuzang.github.io/2019/09/blockchain-and-anomaly-detection/><link rel=next href=https://shuzang.github.io/2019/09/hugo-blog-theme-beautify/><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><link rel=stylesheet href=/css/style.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"hugo搭建个人博客4-部署优化","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shuzang.github.io\/2019\/09\/hugo-build-blog-deployment-optimization\/"},"image":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/cover.png","width":800,"height":600},"genre":"posts","keywords":"Hugo","wordcount":4425,"url":"https:\/\/shuzang.github.io\/2019\/09\/hugo-build-blog-deployment-optimization\/","datePublished":"2019-09-29","dateModified":"2020-02-12","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/shuzang.github.io\/logo.png","width":127,"height":40}},"author":{"@type":"Person","name":"shuzang"},"description":""}</script></head><body><script>if(!window.localStorage||!window.localStorage.getItem('theme')){window.isDark=window.matchMedia('(prefers-color-scheme: dark)').matches;}else{window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';}
window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/>Shuzang's Blog</a></div><div class=menu><a class=menu-item href=/posts rel="noopener noreffer">Posts</a><a class=menu-item href=/tags rel="noopener noreffer">Tags</a><a class=menu-item href=/categories rel="noopener noreffer">Categories</a><a class=menu-item href=/about rel="noopener noreffer">About</a><span class=menu-item>|</span>
<a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></header><header class=mobile id=header-mobile><div class=header-wrapper><div class=header-container><div class=header-title><a href=/>Shuzang's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts rel="noopener noreffer">Posts</a><a class=menu-item href=/tags rel="noopener noreffer">Tags</a><a class=menu-item href=/categories rel="noopener noreffer">Categories</a><a class=menu-item href=/about rel="noopener noreffer">About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><script>window.desktopHeaderMode="fixed";window.mobileHeaderMode="auto";</script><main class=main><div class=container><article class="page single"><h1 class="single-title animated flipInX">hugo搭建个人博客4-部署优化</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://shuzang.top/about/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>shuzang</a>
</span>&nbsp;
<span class=post-category>included in<a href=/categories/%E7%88%B1%E7%BC%96%E7%A8%8B%E7%88%B1%E6%8A%80%E6%9C%AF%E7%9A%84%E5%AD%A9%E5%AD%90>
<i class="far fa-folder fa-fw"></i>爱编程爱技术的孩子</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i><time datetime=2019-09-29>2019-09-29</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 4425 words&nbsp;
<i class="far fa-clock fa-fw"></i>9 min&nbsp;<span id=/2019/09/hugo-build-blog-deployment-optimization/ class=leancloud_visitors data-flag-title=hugo搭建个人博客4-部署优化>
<i class="far fa-eye fa-fw"></i><span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-sizes=auto data-srcset="http://bimgs.plmeizi.com/images/bing/2020/OHR.SnowHare_ZH-CN9767012872_1920x1080.jpg, http://bimgs.plmeizi.com/images/bing/2020/OHR.SnowHare_ZH-CN9767012872_1920x1080.jpg 1.5x, http://bimgs.plmeizi.com/images/bing/2020/OHR.SnowHare_ZH-CN9767012872_1920x1080.jpg 2x" data-src=http://bimgs.plmeizi.com/images/bing/2020/OHR.SnowHare_ZH-CN9767012872_1920x1080.jpg alt></div><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><div class=toc id=toc-static><details><summary><div class=toc-title><span>Contents</span>
<span><i class="details icon fas fa-angle-down"></i></span></div></summary><div class=toc-content id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-使用ci持续集成>1. 使用CI持续集成</a><ul><li><a href=#11-一些说明>1.1 一些说明</a></li><li><a href=#12-申请token>1.2 申请Token</a></li><li><a href=#13-设置travis-ci>1.3 设置Travis CI</a></li><li><a href=#14-编写-travisyml>1.4 编写 .travis.yml</a></li><li><a href=#15-使用说明>1.5 使用说明</a></li></ul></li><li><a href=#2-使用github-action持续集成>2 使用Github Action持续集成</a><ul><li><a href=#21-新建分支保存源码>2.1 新建分支保存源码</a></li><li><a href=#22-设置持续集成>2.2 设置持续集成</a></li></ul></li><li><a href=#3-添加独立域名>3. 添加独立域名</a><ul><li><a href=#31-选购域名>3.1 选购域名</a></li><li><a href=#32-dns解析>3.2 DNS解析</a></li><li><a href=#33-github-上的设置>3.3 GitHub 上的设置</a></li><li><a href=#34-其他玩法>3.4 其他玩法</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></details></div><div class=content id=content><h2 id=1-使用ci持续集成>1. 使用CI持续集成</h2><p>为了存放博客网站源码和博文，一直使用的都是blog仓库，但这同时导致了博客的域名只能是<code>shuzang.github.io/blog</code>，不符合习惯，因为大家习惯性的都会输入<code>username.github.io</code>来寻找每个人的个人博客。</p><p>通过Travis CI做博客的持续集成，可以每次自动渲染生成新的博客网页并推送到<code>shuzang.github.io</code>仓库，从而实现调整域名的目的。但之前尝试了多次持续集成都没有成功，还把博客搞坏了，最终只能重建网站。这一次发现了之前存在的问题，终于成功了。</p><h3 id=11-一些说明>1.1 一些说明</h3><p>有很多人使用一个仓库<code>username.github.io</code>来完成整个流程，将源码存放在<code>blog</code>分支中，然后开启持续集成将网页文件推送到<code>master</code>分支。但我用的是另一种方式，建立两个仓库，<code>blog</code>存放源码，<code>username.github.io</code>展示网站，这种方式用的人少，但有以下优点：</p><ul><li>结构清晰。两个仓库各司其职（其实主要是使用一个仓库出错，解决不了）</li><li>源码存放在master分支下，clone和提交更容易</li></ul><p>下面就是开启持续集成的整个流程了</p><h3 id=12-申请token>1.2 申请Token</h3><p>在GitHub 上申请一个新的 <a href=https://github.com/settings/tokens/new target=_blank rel="noopener noreffer">personal access token</a>
。</p><p><code>Token description</code>随便填，只要之后查看的时候知道是博客的就行。勾选所有<code>repo</code>列表项目，其它项目不要选。点击<code>Generate token</code>生成Token。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HVOiD.png,  1.5x,  2x" data-src alt=申请Token title=申请Token></p><p>之后跳转的页面会显示Token的值，一定要记下来，因为离开这个页面之后这个值就再也无法查看。我因为已经做过一次了，这里就只查看一下。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HVjRH.png,  1.5x,  2x" data-src alt="blog token" title="blog token"></p><h3 id=13-设置travis-ci>1.3 设置Travis CI</h3><p><a href=https://travis-ci.org/account/repositories target=_blank rel="noopener noreffer">Travis CI</a>
是一个持续集成的工具，使用GitHub账号登陆，然后开启<code>blog</code>仓库，选择<code>setting</code>。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HVbdK.png,  1.5x,  2x" data-src alt=开启blog仓库持续集成 title=开启blog仓库持续集成></p><p>在设置页面填写<strong>Environment Variables</strong>。</p><ul><li><strong>Name</strong> 填写： <code>GITHUB_TOKEN</code></li><li><strong>Value</strong> 填写：刚刚在 GitHub 申请到的 Token 的值</li></ul><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HVhRJ.png,  1.5x,  2x" data-src alt=填写环境变量 title=填写环境变量></p><p>填写完成后点击<code>Add</code>添加</p><h3 id=14-编写-travisyml>1.4 编写 .travis.yml</h3><p>在博客根目录下创建并编辑<code>.travis.yml</code>文件，该文件的作用是告诉Travis CI如何部署博客</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ls -al blog
total <span class=m>30</span>
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>29</span> 20:28 ./
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>28</span> 18:20 ../
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>29</span> 20:28 .git/
-rw-r--r-- <span class=m>1</span> 书葬 <span class=m>197610</span>  <span class=m>101</span> 9月  <span class=m>28</span> 18:21 .gitmodules
-rw-r--r-- <span class=m>1</span> 书葬 <span class=m>197610</span> <span class=m>1810</span> 9月  <span class=m>29</span> 20:10 .travis.yml
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>28</span> 18:21 archetypes/
-rw-r--r-- <span class=m>1</span> 书葬 <span class=m>197610</span> <span class=m>4946</span> 9月  <span class=m>29</span> 18:27 config.toml
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>28</span> 18:24 content/
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>29</span> 18:56 docs/
-rw-r--r-- <span class=m>1</span> 书葬 <span class=m>197610</span>  <span class=m>456</span> 9月  <span class=m>29</span> 20:28 README.md
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>28</span> 18:21 resources/
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>28</span> 18:21 static/
drwxr-xr-x <span class=m>1</span> 书葬 <span class=m>197610</span>    <span class=m>0</span> 9月  <span class=m>28</span> 18:21 themes/
</code></pre></td></tr></table></div></div><p>文件内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>language</span><span class=p>:</span><span class=w> </span>go<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>go</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- <span class=s2>&#34;1.12&#34;</span><span class=w>  </span><span class=c># 指定Golang 1.12</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>dist</span><span class=p>:</span><span class=w> </span>bionic<span class=w>  </span><span class=c># Ubuntu 18.04</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>env</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w> </span><span class=k>global</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>   </span><span class=c># Github Pages</span><span class=w>
</span><span class=w>   </span>- <span class=k>GH_REF</span><span class=p>:</span><span class=w> </span>github.com/shuzang/shuzang.github.io<span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Specify which branches to build using a safelist</span><span class=w>
</span><span class=w></span><span class=c># 分支白名单限制：只有 master 分支的提交才会触发构建</span><span class=w>
</span><span class=w></span><span class=c># branches:</span><span class=w>
</span><span class=w></span><span class=c>#   only:</span><span class=w>
</span><span class=w></span><span class=c>#     - master</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>before_install</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=c># 安装依赖</span><span class=w>
</span><span class=w>  </span><span class=c>#  - wget -q -O libstdc++6.deb http://security.ubuntu.com/ubuntu/pool/main/g/gcc-5/libstdc++6_5.4.0-6ubuntu1~16.04.10_amd64.deb</span><span class=w>
</span><span class=w>  </span><span class=c>#  - sudo dpkg --force-all -i libstdc++6.deb</span><span class=w>
</span><span class=w>  </span><span class=c># 删除docs文件夹</span><span class=w>
</span><span class=w>  </span>- rm<span class=w> </span>-rf<span class=w> </span>./docs<span class=w>
</span><span class=w>  </span><span class=c># 安装 hugo （version: v0.58.0）</span><span class=w>
</span><span class=w>  </span>- wget<span class=w> </span>-q<span class=w> </span>-O<span class=w> </span>hugo.deb<span class=w> </span>https<span class=p>:</span>//github.com/gohugoio/hugo/releases/download/v0<span class=m>.58</span><span class=m>.3</span>/hugo_extended_0<span class=m>.58</span>.3_Linux-64bit.deb<span class=w>
</span><span class=w>  </span>- sudo<span class=w> </span>dpkg<span class=w> </span>-i<span class=w> </span>hugo.deb<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>install</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=c># 运行hugo命令</span><span class=w>
</span><span class=w>  </span>- hugo<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- cd<span class=w> </span>./docs<span class=w>
</span><span class=w>  </span>- git<span class=w> </span>init<span class=w>
</span><span class=w>  </span>- git<span class=w> </span>config<span class=w> </span>user.name<span class=w> </span><span class=s2>&#34;shuzang&#34;</span><span class=w>
</span><span class=w>  </span>- git<span class=w> </span>config<span class=w> </span>user.email<span class=w> </span><span class=s2>&#34;lylw1996@qq.com&#34;</span><span class=w>
</span><span class=w>  </span>- git<span class=w> </span>add<span class=w> </span>.<span class=w>
</span><span class=w>  </span>- git<span class=w> </span>commit<span class=w> </span>-m<span class=w> </span><span class=s2>&#34;Update Blog By TravisCI With Build $TRAVIS_BUILD_NUMBER&#34;</span><span class=w>
</span><span class=w>  </span><span class=c># Github Pages</span><span class=w>
</span><span class=w>  </span>- git<span class=w> </span>push<span class=w> </span>--force<span class=w> </span>--quiet<span class=w> </span><span class=s2>&#34;https://$GITHUB_TOKEN@${GH_REF}&#34;</span><span class=w> </span>master<span class=p>:</span>master<span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># before_deploy:</span><span class=w>
</span><span class=w></span><span class=c>#   # 防止其与 mogeko.github.io 冲突</span><span class=w>
</span><span class=w></span><span class=c>#   - rm -f CNAME</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># # 备份</span><span class=w>
</span><span class=w></span><span class=c># deploy:</span><span class=w>
</span><span class=w></span><span class=c>#   provider: pages # 重要，指定这是一份github pages的部署配置</span><span class=w>
</span><span class=w></span><span class=c>#   skip-cleanup: true # 重要，不能省略</span><span class=w>
</span><span class=w></span><span class=c>#   local-dir: public # 静态站点文件所在目录</span><span class=w>
</span><span class=w></span><span class=c>#   # target-branch: master # 要将静态站点文件发布到哪个分支</span><span class=w>
</span><span class=w></span><span class=c>#   github-token: $GITHUB_TOKEN # 重要，$GITHUB_TOKEN是变量，需要在GitHub上申请、再到配置到Travis</span><span class=w>
</span><span class=w></span><span class=c>#   # fqdn: blog.yuantops.com # 如果是自定义域名，此处要填</span><span class=w>
</span><span class=w></span><span class=c>#   keep-history: true # 是否保持target-branch分支的提交记录</span><span class=w>
</span><span class=w></span><span class=c>#   on:</span><span class=w>
</span><span class=w></span><span class=c>#     branch: master # 博客源码的分支</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>大部分都有注释说明，这里要注意的两点是</p><ol><li>在运行<code>hugo</code>命令前要先删除<code>docs</code>文件夹，是为了清除历史网页文件，这是Hugo官方建议的</li><li>注释掉了常规github pages进行持续集成时使用的<code>deploy</code>部分，因为我们只需要单纯的把网页文件提交到另一个仓库。只有当普通的项目启用github pages时需要这部分，这里的博客部署不需要，开启<code>deploy</code>部分反而会出现错误，目前不知道原因。</li></ol><h3 id=15-使用说明>1.5 使用说明</h3><p>大部分工作都通过Travis CI自动进行了，以后提交只需要在改动之后直接<code>git push</code>到远程仓库，将会触发自动构建，只需要一两分钟，就可以在<a href=https://travis-ci.org/ target=_blank rel="noopener noreffer">Travis CI</a>
上查看部署情况。</p><p><font color=green>绿色</font> 代表部署成功  <font color=yellow>黄色</font> 代表正在部署  <font color=red>红色</font> 代表部署失败  <font color=gray>灰色</font> 代表部署被取消</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HVos1.png,  1.5x,  2x" data-src alt=持续集成通过 title=持续集成通过></p><p>然后访问<a href=https://shuzang.github.io target=_blank rel="noopener noreffer">博客首页</a>
，不出意外就可以看到新的改动了。如果部署失败，在网页端的日志记录中找到失败原因，然后修改代码重新提交即可，新的提交通过后，原先失败的提交将会被解决。</p><h2 id=2-使用github-action持续集成>2 使用Github Action持续集成</h2><p><a href=https://github.com/features/actions target=_blank rel="noopener noreffer">GitHub Actions</a>
是 GitHub 在2018年10月推出的一个<a href=http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html target=_blank rel="noopener noreffer">持续集成服务</a>
，之前一直是试用阶段，去年(2019年)年末刚刚开放，据说比<a href=http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html target=_blank rel="noopener noreffer">Travis CI</a>
更简单更好用，所以打算把持续集成工具切换到它。同时，之前博客部署使用了两个仓库，一个放源码，一个放生成的网页文件，目前来看可以统一成一个。本篇文章就打算做这两件事。</p><p>Github Actions入门可以阅读<a href=https://help.github.com/en/actions/automating-your-workflow-with-github-actions target=_blank rel="noopener noreffer">官方文档</a>
或者阮一峰大神的<a href=http://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html target=_blank rel="noopener noreffer">GitHub Actions 入门教程</a></p><h3 id=21-新建分支保存源码>2.1 新建分支保存源码</h3><p>统一使用<code>shuzang.github.io</code>这个仓库，<code>master</code>分支用于放置生成的博客网页文件，这是Github Pages的要求，新建分支<code>blog</code>存放博客源码和写的文章。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 新建并切换到新分支</span>
$ git checkout -b blog
$ git branch
* blog
  master
<span class=c1># 设置本地blog分支追踪远程blog分支</span>
$ git branch --set-upstream blog origin/blog
<span class=c1># 查看分支跟踪关系</span>
$ git branch -vv
* blog   c63526c <span class=o>[</span>origin/blog<span class=o>]</span> Update posts
  master aa725ba <span class=o>[</span>origin/master: behind 1<span class=o>]</span> Automated deployment: Wed Feb  <span class=m>5</span> 09:25:59 UTC <span class=m>2020</span> d8e4f52983c7d7b2128076df3b267bd27259d447
</code></pre></td></tr></table></div></div><p>删除原来Travis CI用到的<code>.travis.yml</code>文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ rm .travis.yml
</code></pre></td></tr></table></div></div><p>然后将本地blog分支的内容推送到远程，在网页端进入<code>shuzang.github.io</code>仓库的设置页面，将默认分支设置为blog分支。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HePXR.png,  1.5x,  2x" data-src alt=设置默认分支 title=设置默认分支></p><h3 id=22-设置持续集成>2.2 设置持续集成</h3><p>生成公私钥用于持续集成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>ssh-keygen -t rsa -b <span class=m>4096</span> -C <span class=s2>&#34;</span><span class=k>$(</span>git config user.email<span class=k>)</span><span class=s2>&#34;</span> -f blog -N <span class=s2>&#34;&#34;</span>
<span class=c1># You will get 2 files in current file:</span>
<span class=c1>#   blog.pub (public key)</span>
<span class=c1>#   blog     (private key)</span>
</code></pre></td></tr></table></div></div><p>然后进入<code>shuzang.github.io</code>仓库设置页面，在<code>Deploy Keys</code>中添加公钥，在<code>Secrets</code>中添加私钥，私钥名设置为<code>ACTIONS_DEPLOY_KEY</code></p><p>然后新建YAML配置文件，Github Action要求配置文件位于<code>.github/workflows</code>目录下，新建完成后目录结构如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ls ./.github/workflows
main.yml
</code></pre></td></tr></table></div></div><p>Github Action使用一种模块化的思路，即将很多持续集成的操作写成独立的脚本文件，放到代码仓库，让其它开发者是哦那个，因此进行持续集成时，可以直接引用别人写好的action，整个持续集成的过程，就是一个actions组合的过程。GitHub 做了一个<a href="https://github.com/marketplace?type=actions" target=_blank rel="noopener noreffer">官方市场</a>
，可以搜索到他人提交的 actions。另外，还有一个 <a href=https://github.com/sdras/awesome-actions target=_blank rel="noopener noreffer">awesome actions</a>
的仓库，也可以找到不少 action。</p><p>我们的基本思路如下</p><ol><li>整个流程在blog分支push时触发</li><li>只有一个job，运行在ubuntu-18.04环境下</li><li>使用<a href=https://github.com/actions/checkout target=_blank rel="noopener noreffer">official action: checkout</a>
获取仓库源码，注意添加参数clone主题子模块</li><li>使用<a href=https://github.com/peaceiris/actions-hugo target=_blank rel="noopener noreffer">peaceiris/actions-hugo: GitHub Actions for Hugo</a>
部署hugo环境，注意使用<code>extentded</code>版本（主题要求）</li><li>直接执行hugo命令</li><li>使用<a href=https://github.com/peaceiris/actions-gh-pages target=_blank rel="noopener noreffer">peaceiris/actions-gh-pages</a>
将当前分支<code>public</code>目录下的内容部署到master分支，</li></ol><p>完整的<code>main.yml</code>脚本内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>name</span><span class=p>:</span><span class=w> </span>hugo<span class=w> </span>push<span class=w> </span>to<span class=w> </span>github<span class=w> </span>pages<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>on</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>push</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>branches</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- blog<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>jobs</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>build-deploy</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>runs-on</span><span class=p>:</span><span class=w> </span>ubuntu<span class=m>-18.04</span><span class=w>
</span><span class=w>    </span><span class=k>steps</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=k>uses</span><span class=p>:</span><span class=w> </span>actions/checkout@v1<span class=w>
</span><span class=w>      </span><span class=k>with</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>submodules</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>Setup<span class=w> </span>Hugo<span class=w>
</span><span class=w>      </span><span class=k>uses</span><span class=p>:</span><span class=w> </span>peaceiris/actions-hugo@v2<span class=w>
</span><span class=w>      </span><span class=k>with</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>hugo-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.59.1&#39;</span><span class=w>
</span><span class=w>        </span><span class=k>extended</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>Build<span class=w>
</span><span class=w>      </span><span class=k>run</span><span class=p>:</span><span class=w> </span>hugo<span class=w> </span>--minify<span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>Deploy<span class=w>
</span><span class=w>      </span><span class=k>uses</span><span class=p>:</span><span class=w> </span>peaceiris/actions-gh-pages@v2<span class=w>
</span><span class=w>      </span><span class=k>env</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>        </span><span class=k>ACTIONS_DEPLOY_KEY</span><span class=p>:</span><span class=w> </span>${{<span class=w> </span>secrets.ACTIONS_DEPLOY_KEY<span class=w> </span>}}<span class=w>
</span><span class=w>        </span><span class=k>PUBLISH_BRANCH</span><span class=p>:</span><span class=w> </span>master<span class=w>
</span><span class=w>        </span><span class=k>PUBLISH_DIR</span><span class=p>:</span><span class=w> </span>./public<span class=w>
</span></code></pre></td></tr></table></div></div><p>保存上面的文件后，将本地仓库推送到远程，Github检测到<code>.github/workflow</code>目录和里面的<code>main.yml</code>文件，就会自动运行，在网页端可以查看运行日志，如果出现错误可以根据日志内容就行修改。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HeehD.png,  1.5x,  2x" data-src alt="Github Action 日志文件" title="Github Action 日志文件"></p><p>等到workflow运行结束，访问博客页面，就可以看到更新成功了。切换到master分支，也可以看到推送的网页文件，不过因为设置了默认分支为blog，以后打开网页端该仓库，以及在本地clone的时候，默认都是blog分支。</p><h2 id=3-添加独立域名>3. 添加独立域名</h2><p>给部署在 GitHub Pages 上的博客添加独立域名，是早就想做的事，以前是因为没什么需求，.me域名比较贵，国内购买域名备案又比较麻烦，所以一直没做。这次选择了.top域名，买了三年才67，可以了，三年以后开始工作再考虑换.me域名，毕竟这个冷门的字段应该没人要。而且发现部署在github pages不需要备案，因为服务器不在国内。</p><h3 id=31-选购域名>3.1 选购域名</h3><p>可能很多人已经买好了域名了，你可以[跳过这部分](#GitHub 上的设置)</p><p>要想给博客绑定独立域名，首先你得拥有一个域名。得去域名注册网站购买域名，国内的域名商推荐<a href=https://wanwang.aliyun.com/ target=_blank rel="noopener noreffer">万网</a>
，国外的推荐 <a href=https://www.godaddy.com/ target=_blank rel="noopener noreffer">GoDaddy</a>
，因为他们分别是中国最大和世界最大的域名注册服务商。不了解的领域当然挑知名有信誉的总是没错的。</p><p>要是买<code>.me</code>域名就真的只能在GoDaddy买了，首年24，续费不知道，但是还需要购买隐私保护，这样就变成了每年60，要是工作后还负担的起，现在买这个还是算了。<code>.io</code>首年就320，更负担不起了。国内的话，<code>.com</code>，<code>.net</code>这些就不想了，基本都已经被注册了，于是选择了<code>.top</code>，一口气买了三年，一共67，而且在国内购买的好处是本身对WHOIS中的个人信息提供隐私保护。阿里云之前对域名提供的隐私保护服务已经停用了，主要是因为</p><blockquote><p>为落实<a href=https://www.icann.org/news/announcement-2018-05-22-zh target=_blank rel="noopener noreffer">ICANN临时规范</a>
要求，自2018年5月25日起阿里云WHOIS查询公开信息中将不再显示域名注册人、管理联系人和技术联系人的个人数据，包括姓名、邮箱、电话、街道地址等。</p></blockquote><p>这样域名的注册信息已得到默认保护，不再需要额外开通隐私保护。</p><p>具体选购过程大致是：<strong>搜索域名 -> 将喜欢的域名加入购物车 ->选择域名注册模板(没有的话要创建)-> 付款 -> 购买成功</strong>，实际使用还需要进行邮箱验证和实名认证，否则域名无法启用。</p><p>最为繁琐的域名备案过程可以跳过，因为博客挂载在github pages，而只有服务器在国内的网站才需要备案。</p><h3 id=32-dns解析>3.2 DNS解析</h3><p>使用CNAME别名映射域名，比设置A记录更方便，最重要的是A记录无法开启https。参数设置如下图所示。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1Heu1H.png,  1.5x,  2x" data-src alt=CNAME设置 title=CNAME设置></p><p>访问网址时可能会加www前缀，因此可以设置一个二级域名解析，方法相同。</p><h3 id=33-github-上的设置>3.3 GitHub 上的设置</h3><p>到 Github <code>shuzang.github.io</code>仓库设置里，在 <code>Custom domain</code> 这里填写<code>shuzang.top</code>域名并保存。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1He3HP.png,  1.5x,  2x" data-src alt=github域名设置 title=github域名设置></p><p><code>Custom domain</code> 下方 <code>Enforce HTTPS</code> 这个选项一并勾选，Github 跟 Let’s Encrypt 有合作，如果勾选了这个选项，Let’s Encrypt 就会给你的博客签发一张 SSL 证书，免费的。</p><p><img class=lazyload src=/svg/loading.small.min.svg data-sizes=auto data-srcset="/images/hugo%e6%90%ad%e5%bb%ba%e4%b8%aa%e4%ba%ba%e5%8d%9a%e5%ae%a24-%e9%83%a8%e7%bd%b2%e4%bc%98%e5%8c%96/1HeJN8.png,  1.5x,  2x" data-src alt=启用HTTPS title=启用HTTPS></p><p>发现上面这种方法每次提交后都需要重新填写<code>custom domin</code>字段，因此采用另一种方式，创建一个名为 <code>CNAME</code> 的文件放在<code>content</code>目录，其中的内容<strong>只</strong>写上你的域名，像这样</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>shuzang.top
</code></pre></td></tr></table></div></div><p>使用hugo命令生成文件会将CNAME文件直接复制到public目录，并通过持续集成将其推送到master分支根目录。</p><p>等几分钟 (刷新 DNS 缓存)，然后在浏览器中输入<code>shuzang.top</code>，回车，不出意外看到了自己的博客。</p><h3 id=34-其他玩法>3.4 其他玩法</h3><p>除了将域名绑定给博客外博客，还可以用域名干一些别的事。</p><p>比如，<strong>使用 A 记录将 <code>mail.shuzang.me</code> 这个二级域名指向 <code>207.46.149.80</code> 就可以 “搭建” 一个 <a href=http://mail.shuzang.top/ target=_blank rel="noopener noreffer">临时邮箱</a>
服务</strong> (感谢 <a href=https://moeclub.org/ target=_blank rel="noopener noreffer">萌咖 | MoeClub.org</a>
提供的服务器)</p><p>如果你还有一台拥有<strong>公网 IP</strong> 的服务器，可玩性就更高了！</p><p>如果有能力，你甚至可以拥有自己的<a href=https://nutch.apache.org/ target=_blank rel="noopener noreffer">搜索引擎</a></p><h2 id=参考>参考</h2><p>[1] <a href=https://github.com/Mogeko/Blog target=_blank rel="noopener noreffer">Mogeko的博客</a></p><p>[2] <a href=https://mogeko.me/2019/048/ target=_blank rel="noopener noreffer">为博客添加独立域名</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>The article was updated on 2020-02-12</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2019/09/hugo-build-blog-deployment-optimization/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://shuzang.github.io/2019/09/hugo-build-blog-deployment-optimization/ data-title=hugo搭建个人博客4-部署优化 data-hashtags=Hugo><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://shuzang.github.io/2019/09/hugo-build-blog-deployment-optimization/ data-hashtag=Hugo><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://shuzang.github.io/2019/09/hugo-build-blog-deployment-optimization/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/hugo>Hugo</a></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2019/09/blockchain-and-anomaly-detection/ class=prev rel=prev title=阶段总结4-区块链与异常检测><i class="fas fa-angle-left fa-fw"></i>阶段总结4-区块链与异常检测</a>
<a href=/2019/09/hugo-blog-theme-beautify/ class=next rel=next title=hugo搭建个人博客5-主题美化>hugo搭建个人博客5-主题美化<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=comment><div id=valine></div><script>document.addEventListener("DOMContentLoaded",function(event){new Valine({el:'#valine',appId:'GteMvevTjOBmhvFh2QGsopGO-gzGzoHsz',appKey:'fL4SYl06GIe012PswFdY17VC',placeholder:'Your comment ...',verify:true,avatar:'hide',pageSize:10,lang:'en',visitor:true,recordIP:true,});});</script><noscript>Please enable JavaScript to view the <a href=https://valine.js.org/>comments powered by Valine.</a></noscript></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer"><i class="far fa-heart fa-fw"></i>LoveIt</a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shuzang.top/about/ target=_blank>shuzang</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><a href=# class="dynamic-to-top animated faster" id=dynamic-to-top><i class="fas fa-chevron-up fa-fw"></i></a><script>document.addEventListener('DOMContentLoaded',function(){lightGallery(document.getElementById('content'),{selector:'.lightgallery',speed:400,hideBarsDelay:2000,thumbnail:true,exThumbImage:'data-thumbnail',thumbWidth:80,thumbContHeight:80,});});</script><link rel=stylesheet href=/lib/valine/valine.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script src=https://cdn.bootcss.com/smooth-scroll/16.1.0/smooth-scroll.js></script><script src=https://cdn.bootcss.com/lazysizes/5.1.2/lazysizes.min.js></script><script src=/lib/valine/Valine.min.js></script><script src=/lib/sharer/sharer.min.js></script><script src=/lib/lightgallery/lightgallery.min.js></script><script src=/lib/lightgallery/lg-thumbnail.min.js></script><script src=/lib/lightgallery/lg-zoom.min.js></script><script src=/js/theme.min.js></script></body></html>